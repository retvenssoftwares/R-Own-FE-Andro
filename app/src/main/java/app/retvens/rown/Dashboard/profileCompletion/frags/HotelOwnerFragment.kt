package app.retvens.rown.Dashboard.profileCompletion.frags

import android.app.Dialog
import android.content.ContentResolver
import android.content.Intent
import android.graphics.Bitmap
import android.graphics.Color
import android.graphics.drawable.ColorDrawable
import android.net.Uri
import android.os.Bundle
import android.os.Environment
import android.provider.MediaStore
import android.provider.OpenableColumns
import android.util.Log
import android.view.Gravity
import androidx.fragment.app.Fragment
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.view.Window
import android.widget.ImageView
import android.widget.LinearLayout
import android.widget.RelativeLayout
import android.widget.Toast
import androidx.activity.result.contract.ActivityResultContracts
import androidx.appcompat.app.AppCompatActivity
import androidx.cardview.widget.CardView
import androidx.constraintlayout.widget.ConstraintLayout
import androidx.core.content.FileProvider
import app.retvens.rown.ApiRequest.RetrofitBuilder
import app.retvens.rown.Dashboard.DashBoardActivity
import app.retvens.rown.Dashboard.profileCompletion.BackHandler
import app.retvens.rown.DataCollections.ProfileCompletion.UpdateResponse
import app.retvens.rown.R
import com.google.android.material.imageview.ShapeableImageView
import com.google.android.material.textfield.TextInputEditText
import com.google.android.material.textfield.TextInputLayout
import com.theartofdev.edmodo.cropper.CropImage
import com.theartofdev.edmodo.cropper.CropImageView
import okhttp3.MediaType.Companion.toMediaTypeOrNull
import okhttp3.MultipartBody
import okhttp3.RequestBody
import retrofit2.Call
import retrofit2.Callback
import retrofit2.Response
import java.io.File
import java.io.FileInputStream
import java.io.FileOutputStream
import java.io.IOException

class HotelOwnerFragment : Fragment(), BackHandler {


    lateinit var hotelType : TextInputEditText
    lateinit var singleHotelLayout : ConstraintLayout
    lateinit var chainHotelLayout : ConstraintLayout
    private var nextScreen : Int = 0
    private var cameraUser : String = ""
    lateinit var dialog: Dialog



    /*-----------------------SINGLE HOTEL--------------------------------*/
    /*-----------------------SINGLE HOTEL--------------------------------*/
    lateinit var noOfHotels : TextInputEditText
    lateinit var hotelOwnerStarET : TextInputEditText
    lateinit var hotelOwnerProfile  : ShapeableImageView
    lateinit var hotelOwnerCover  : ShapeableImageView
    lateinit var ownerHotel : TextInputEditText

    private var croppedOwnerProfileImageUri: Uri? = null // Final Uri for Owner Profile
    private var croppedOwnerCoverImageUri: Uri? = null  // Final Uri for Owner Cover
    /*-----------------------HOTEL CHAIN--------------------------------*/
    /*-----------------------HOTEL CHAIN--------------------------------*/

    lateinit var cameraHotelChain : ImageView
    lateinit var hotelChainProfile : ShapeableImageView
    var PICK_IMAGE_REQUEST_CODE : Int = 0
    //Cropped image uri
    private var croppedHotelChainImageUri: Uri?= null  // Final Uri for Hotel chain

    var REQUEST_CAMERA_PERMISSION : Int = 0
    lateinit var cameraHotelChainImageUri: Uri
    private val contract = registerForActivityResult(ActivityResultContracts.TakePicture()){
//        cropImage(cameraHotelChainImageUri)

        Log.d("owner", "cameraUser")
        if (cameraUser == "ChainProfile") {
            Log.d("owner", cameraUser)
            croppedHotelChainImageUri = cameraHotelChainImageUri
            hotelChainProfile.setImageURI(croppedHotelChainImageUri)
        }else if (cameraUser == "OwnerProfile"){
            Log.d("owner", cameraUser)
            croppedOwnerProfileImageUri = cameraHotelChainImageUri
            hotelOwnerProfile.setImageURI(croppedOwnerProfileImageUri)
        }else{
            Log.d("owner", cameraUser)
            croppedOwnerCoverImageUri = cameraHotelChainImageUri
            hotelOwnerCover.setImageURI(croppedOwnerCoverImageUri)
        }
    }

    override fun onCreateView(
        inflater: LayoutInflater, container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? {
        // Inflate the layout for this fragment
        return inflater.inflate(R.layout.fragment_hotel_owner, container, false)
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)

        ownerHotel = view.findViewById(R.id.owner_Hotel)

        hotelType = view.findViewById<TextInputEditText>(R.id.hotel_type_et)
        singleHotelLayout = view.findViewById(R.id.cons_single_hotel)
        chainHotelLayout = view.findViewById(R.id.cons_chain_hotel)
        hotelType.setOnClickListener {
            openHotelTypeBottom()
        }

        /*-----------------------SINGLE HOTEL--------------------------------*/
        /*-----------------------SINGLE HOTEL--------------------------------*/
        noOfHotels = view.findViewById<TextInputEditText>(R.id.noOfHotels)
        hotelOwnerStarET = view.findViewById<TextInputEditText>(R.id.hotel_owner_star_et)

        hotelOwnerStarET.setOnClickListener {
            openBottomStarSelection()
        }

        hotelOwnerProfile = view.findViewById(R.id.hotel_owner_profile)
        hotelOwnerProfile.setOnClickListener {
            cameraUser = "OwnerProfile"
            openBottomCameraSheet("OwnerProfile")
        }
        hotelOwnerCover = view.findViewById(R.id.hotel_owner_cover)
        hotelOwnerCover.setOnClickListener {
            cameraUser = "OwnerCover"
            openBottomCameraSheet("OwnerCover")
        }

        /*-----------------------HOTEL CHAIN--------------------------------*/
        /*-----------------------HOTEL CHAIN--------------------------------*/
        cameraHotelChainImageUri = createImageUri()!!

        hotelChainProfile = view.findViewById(R.id.hotel_chain_profile)
        cameraHotelChain = view.findViewById(R.id.camera_hotelChain)
        cameraHotelChain.setOnClickListener {
            cameraUser = "ChainProfile"
            openBottomCameraSheet("ChainProfile")
        }

        view.findViewById<CardView>(R.id.card_owner_next).setOnClickListener {
            if (nextScreen == 1){
                val fragment = HotelOwnerChainFragment()
                val hotels = noOfHotels.text.toString()
                if (hotels.isEmpty()){
                    Toast.makeText(requireContext(), "input hotels", Toast.LENGTH_SHORT).show()
                } else{

                    val bundle = Bundle()
                    bundle.putString("hotels", hotels)

                    fragment.arguments = bundle

                    val transaction = activity?.supportFragmentManager?.beginTransaction()
                    transaction?.replace(R.id.fragment_username,fragment)
                    transaction?.commit()

                }
            }
        }

        val submit = view.findViewById<CardView>(R.id.card_owner_next)

        submit.setOnClickListener {
            UploadData()
        }

    }

    private fun UploadData() {

        val type = hotelType.text.toString()
        val hotelName = ownerHotel.text.toString()
        val star = hotelOwnerStarET.text.toString()

        val parcelFileDescriptor = requireContext().contentResolver.openFileDescriptor(
            croppedOwnerCoverImageUri!!,"r",null
        )?:return


        val inputStream = FileInputStream(parcelFileDescriptor.fileDescriptor)
        val file =  File(requireContext().cacheDir, "cropped_${requireContext().contentResolver.getFileName(croppedOwnerCoverImageUri!!)}.jpg")
        val outputStream = FileOutputStream(file)
        inputStream.copyTo(outputStream)
        val body = UploadRequestBody(file,"image")

//        val parcelFileDescriptor1 = requireContext().contentResolver.openFileDescriptor(
//            croppedOwnerProfileImageUri!!,"r",null
//        )?:return
//
//
//
//        val inputStream1 = FileInputStream(parcelFileDescriptor1.fileDescriptor)
//        val file1 = File(requireContext().cacheDir, requireContext().contentResolver.getFileName(croppedOwnerProfileImageUri!!) + ".jpg")
//        val outputStream1 = FileOutputStream(file1)
//        inputStream1.copyTo(outputStream1)
//        val body1 = UploadRequestBody(file1,"image")

        val send = RetrofitBuilder.profileCompletion.uploadHotelData(
            RequestBody.create("multipart/form-data".toMediaTypeOrNull(),hotelName),
            RequestBody.create("multipart/form-data".toMediaTypeOrNull(),"indore"),
            RequestBody.create("multipart/form-data".toMediaTypeOrNull(),star),
            MultipartBody.Part.createFormData("hotelData", file.name, body),
            RequestBody.create("multipart/form-data".toMediaTypeOrNull(),"rahul")
        )

        send.enqueue(object : Callback<UpdateResponse?> {
            override fun onResponse(
                call: Call<UpdateResponse?>,
                response: Response<UpdateResponse?>
            ) {
                if (response.isSuccessful){
                    val response = response.body()!!
                    Toast.makeText(requireContext(),response.message,Toast.LENGTH_SHORT).show()
                    startActivity(Intent(requireContext(),DashBoardActivity::class.java))
                }else{
                    Toast.makeText(requireContext(),response.message().toString(),Toast.LENGTH_SHORT).show()
                }
            }

            override fun onFailure(call: Call<UpdateResponse?>, t: Throwable) {
                Toast.makeText(requireContext(),t.message.toString(),Toast.LENGTH_SHORT).show()
            }
        })

    }

    private fun openBottomCameraSheet(user : String) {

        dialog = Dialog(requireContext())
        dialog.requestWindowFeature(Window.FEATURE_NO_TITLE)
        dialog.setContentView(R.layout.bottom_sheet_camera)

        dialog.findViewById<ImageView>(R.id.delete_img).setOnClickListener {
            deleteImage()
        }

        dialog.findViewById<LinearLayout>(R.id.pick_from_gallery).setOnClickListener {
            openGallery()
        }
        dialog.findViewById<LinearLayout>(R.id.pick_from_camera).setOnClickListener {
            openCamera()
        }

        dialog.show()
        dialog.window?.setLayout(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT)
        dialog.window?.setBackgroundDrawable(ColorDrawable(Color.TRANSPARENT))
        dialog.window?.attributes?.windowAnimations = R.style.DailogAnimation
        dialog.window?.setGravity(Gravity.BOTTOM)
    }
    private fun deleteImage() {
        croppedHotelChainImageUri = null
        hotelChainProfile.setImageURI(croppedHotelChainImageUri)
        dialog.dismiss()
    }
    private fun openCamera() {
        contract.launch(cameraHotelChainImageUri)
        dialog.dismiss()
    }
    private fun openGallery() {
        val intent = Intent(Intent.ACTION_PICK, MediaStore.Images.Media.EXTERNAL_CONTENT_URI)
        startActivityForResult(intent,PICK_IMAGE_REQUEST_CODE)
        dialog.dismiss()
    }

    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
        super.onActivityResult(requestCode, resultCode, data)

        if (requestCode == PICK_IMAGE_REQUEST_CODE && resultCode == AppCompatActivity.RESULT_OK && data != null) {
            val imageUri = data.data
            if (imageUri != null) {

//                cropImage(imageUri)

                Log.d("owner", "cameraUser")
                if (cameraUser == "ChainProfile") {
                    Log.d("owner", cameraUser)
                    croppedHotelChainImageUri = imageUri
                    hotelChainProfile.setImageURI(croppedHotelChainImageUri)
                }else if (cameraUser == "OwnerProfile"){
                    Log.d("owner", cameraUser)
                    croppedOwnerProfileImageUri = imageUri
                    hotelOwnerProfile.setImageURI(croppedOwnerProfileImageUri)
                }else{
                    Log.d("owner", cameraUser)
                    croppedOwnerCoverImageUri = imageUri
                    hotelOwnerCover.setImageURI(croppedOwnerCoverImageUri)
                }

            }
        }  else if (requestCode == CropImage.CROP_IMAGE_ACTIVITY_REQUEST_CODE) {
            val resultingImage = CropImage.getActivityResult(data)
            if (resultCode == AppCompatActivity.RESULT_OK) {
                val croppedImage = resultingImage.uri

                Log.d("owner", "cameraUser")
                if (cameraUser == "ChainProfile") {
                    Log.d("owner", cameraUser)
                    croppedHotelChainImageUri = croppedImage
                }else if (cameraUser == "OwnerProfile"){
                    Log.d("owner", cameraUser)
                    croppedOwnerProfileImageUri = croppedImage
                }else{
                    Log.d("owner", cameraUser)
                    croppedOwnerCoverImageUri = croppedImage
                }
            } else if (resultCode == CropImage.CROP_IMAGE_ACTIVITY_RESULT_ERROR_CODE) {
                Toast.makeText(context,"Try Again : ${resultingImage.error}",Toast.LENGTH_SHORT).show()
            }
        }
    }
    private fun cropImage(imageUri: Uri) {
        val options = CropImage.activity(imageUri)
            .setGuidelines(CropImageView.Guidelines.ON)

        options.setAspectRatio(1, 1)
            .setCropShape(CropImageView.CropShape.OVAL)
            .setOutputCompressQuality(20)
            .setOutputCompressFormat(Bitmap.CompressFormat.PNG)
            .start(requireActivity())
    }
    private fun createImageUri(): Uri? {
        val image = File(requireContext().filesDir,"camera_photo.png")
        return FileProvider.getUriForFile(requireContext(),
            "app.retvens.rown.fileProvider",
            image
        )
    }


    private fun openBottomStarSelection() {

        val dialogRole = Dialog(requireContext())
        dialogRole.requestWindowFeature(Window.FEATURE_NO_TITLE)
        dialogRole.setContentView(R.layout.bottom_sheet_hotel_rating)
        dialogRole.setCancelable(true)

        dialogRole.window?.setLayout(ViewGroup.LayoutParams.MATCH_PARENT,ViewGroup.LayoutParams.WRAP_CONTENT)
        dialogRole.window?.setBackgroundDrawable(ColorDrawable(Color.TRANSPARENT))
        dialogRole.window?.attributes?.windowAnimations = R.style.DailogAnimation
        dialogRole.window?.setGravity(Gravity.BOTTOM)
        dialogRole.show()

        dialogRole.findViewById<RelativeLayout>(R.id.oneStar).setOnClickListener {
            hotelOwnerStarET.setText("1 -3 Star")
            dialogRole.dismiss()
        }

        dialogRole.findViewById<RelativeLayout>(R.id.fourStar).setOnClickListener {
            hotelOwnerStarET.setText("4 Star")
            dialogRole.dismiss()
        }

        dialogRole.findViewById<RelativeLayout>(R.id.fiveStar).setOnClickListener {
            hotelOwnerStarET.setText("5 Star")
            dialogRole.dismiss()
        }

        dialogRole.findViewById<RelativeLayout>(R.id.sixStar).setOnClickListener {
            hotelOwnerStarET.setText("6 Star")
            dialogRole.dismiss()
        }
        dialogRole.findViewById<RelativeLayout>(R.id.sevenStar).setOnClickListener {
            hotelOwnerStarET.setText("7 Star")
            dialogRole.dismiss()
        }
        dialogRole.findViewById<RelativeLayout>(R.id.eightStar).setOnClickListener {
            hotelOwnerStarET.setText("8 Star")
            dialogRole.dismiss()
        }
        dialogRole.findViewById<RelativeLayout>(R.id.nineStar).setOnClickListener {
            hotelOwnerStarET.setText("9 Star")
            dialogRole.dismiss()
        }
        dialogRole.findViewById<RelativeLayout>(R.id.tenStar).setOnClickListener {
            hotelOwnerStarET.setText("10 Star")
            dialogRole.dismiss()
        }
        dialogRole.findViewById<RelativeLayout>(R.id.elevenStar).setOnClickListener {
            hotelOwnerStarET.setText(">11 Star")
            dialogRole.dismiss()
        }

    }
    private fun openHotelTypeBottom() {

        val dialogRole = Dialog(requireContext())
        dialogRole.requestWindowFeature(Window.FEATURE_NO_TITLE)
        dialogRole.setContentView(R.layout.bottom_sheet_hotel_type)
        dialogRole.setCancelable(true)

        dialogRole.window?.setLayout(ViewGroup.LayoutParams.MATCH_PARENT,ViewGroup.LayoutParams.WRAP_CONTENT)
        dialogRole.window?.setBackgroundDrawable(ColorDrawable(Color.TRANSPARENT))
        dialogRole.window?.attributes?.windowAnimations = R.style.DailogAnimation
        dialogRole.window?.setGravity(Gravity.BOTTOM)
        dialogRole.show()

        dialogRole.findViewById<RelativeLayout>(R.id.singleHotelRL).setOnClickListener {
            chainHotelLayout.visibility = View.GONE
            singleHotelLayout.visibility = View.VISIBLE
            nextScreen = 0
            hotelType.setText("Single Hotel")
            dialogRole.dismiss()
        }
        dialogRole.findViewById<RelativeLayout>(R.id.hotelChainRL).setOnClickListener {
            chainHotelLayout.visibility = View.VISIBLE
            singleHotelLayout.visibility = View.GONE
            nextScreen = 1
            hotelType.setText("Hotel Chain")
            dialogRole.dismiss()
        }
    }

    override fun handleBackPressed(): Boolean {

        val fragment = BasicInformationFragment()
        val transaction = activity?.supportFragmentManager?.beginTransaction()
        transaction?.replace(R.id.fragment_username,fragment)
        transaction?.commit()

        return true
    }

    private fun ContentResolver.getFileName(coverPhotoPart: Uri): String {

        var name = ""
        val returnCursor = this.query(coverPhotoPart,null,null,null,null)
        if (returnCursor!=null){
            val nameIndex = returnCursor.getColumnIndex(OpenableColumns.DISPLAY_NAME)
            returnCursor.moveToFirst()
            name = returnCursor.getString(nameIndex)
            returnCursor.close()
        }
        return name
    }

}